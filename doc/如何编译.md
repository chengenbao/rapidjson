# 编译&引入

本文档介绍如何编译TubeMQ的C/C++ SDK

[TOC]

## 编译安装

### 前置条件
编译环境：GCC 要求至少4.8的版本； CMake要求至少3.1的版本

依赖组件：新版本的TubeMQ C/C++依赖如下组件

 - CMake
 - ASIO 
 - OpenSSL
 - **ProtocolBuffer**
 - Log4cplus
 - Rapidjson

对于ProtobufBuffer，由于编译起来耗时非常长，大家环境很有可能已经有了，因而没有放到编译脚本里，这个组件需要大家先安装在编译机上：
``` bash
./configure --disable-shared && make && make install
```

如果编译环境不能连外网，大家直接从指定位置下载对应包到CMake脚本位置即可，依赖包的版本没有强制限制。

相关的依赖包在https://git.code.oa.com/tdbank/TubeMQ-Client-Cpp/blob/master/third_party/CMakeLists.txt 文件中，以rapidjson为例，我们将其下载后放在${PROJECT_SOURCE_DIR}的dowload目录下，我们修改CMakeLists里对应依赖组件的URL为如下形式，其他字段不变：
``` bash
ExternalProject_Add(
    rapidjson
    PREFIX "rapidjson"
    URL ${PROJECT_SOURCE_DIR}/dowload/rapidjson-1.1.0.tar.gz
    CMAKE_ARGS
    -DRAPIDJSON_BUILD_TESTS=OFF
    -DRAPIDJSON_BUILD_DOC=OFF
    -DRAPIDJSON_BUILD_EXAMPLES=OFF
    CONFIGURE_COMMAND ""
    BUILD_COMMAND ""
    INSTALL_COMMAND ""
    UPDATE_COMMAND ""
    )
```


### 下载源码

使用git clone源码然后切到最新的tag

### 编译源码
源码下载后就是如下内容

```
|-- CMakeLists.txt       # CMake文件
|
|-- build_linux.sh       # 编译脚本
|
|-- conf                 # SDK的配置文件
|
|-- example              # SDK使用的示例代码
|
|-- include              # SDK头文件
|
|-- proto                # TubeMQ的交互协议
|
|-- release              # 打包目录
|
|-- src                  # SDK源码
|
|-- tests                # 单元测试项
|
`-- third_party          # 静态库
```

1. 先将顶层的脚本build_linux.sh为可执行，然后执行该脚本：
``` bash
# 设置可执行权限
chmod +x build_linux.sh
# 执行脚本
./build_linux.sh
```

2. 设置release目录下的脚本release_linux.sh为可执行，然后执行该脚本：
``` bash
# 进入release目录
cd release
# 设置可执行权限
chmod +x release_linux.sh
# 执行脚本
./release_linux.sh
```
release里对应的conf, include, lib是TubeMQ C/C++的完整依赖，demo提供了一个示例让大家如何编译使用
```
|-- lib                    # SDK的依赖包
|   |-- liblog4cplus.a     # log4cpuls 
|   |-- libprotobuf.a      # protobuf
|   |-- libtubemq.a        # SDK的编译结果
|   |-- libtubemq_proto.a  # tubemq的proto
|   
|-- release_linux.sh       # 打包脚本
|
|-- tubemq                 # SDK的发布内容
|   |-- conf               # SDK配置文件
|   |-- demo               # SDK使用示例
|   |-- include            # SDK头文件
|   |-- lib                # SDK的依赖包
|
`-- tubemq.tar.gz          # SDK发布包的压缩内容，
                           # 与tubemq内容一致，压缩处理
```

需要注意的是，对于ProtobufBuffer，我所在的编译环境是安装在/usr/local/lib下，大家需要根据自己的部署对release_linux.sh内容做调整：
``` bash
 ......
 
 34 cp ../build/src/libtubemq.a lib/
 35 cp ../build/third_party/lib/liblog4cplus.a lib/
 36 cp ../build/third_party/lib64/libsnappy.a lib/
 ** 37 cp ../build/proto/libtubemq_proto.a lib/ **
 38 cp /usr/local/lib/libprotobuf.a lib/
 39 cp -rf ../include/*  tubemq/include/
 40 cp ../conf/* tubemq/conf/
 
 ......
 
```


